# how to generate self-signed certs for nginx
#openssl req -x509 -nodes -days 365 \
  #-newkey rsa:2048 \
 # -keyout media-display.projecttechcycle-dev.org.key \
 # -out media-display.projecttechcycle-dev.org.crt \
 # -subj "/CN=media-display.projecttechcycle-dev.org"
  #

server {
    listen       9080 ssl;
    server_name  media-display.projecttechcycle-dev.org;
    ssl_certificate     /Users/hthai00/Projects/media-display/test/certs/media-display.projecttechcycle-dev.org.crt;
    ssl_certificate_key /Users/hthai00/Projects/media-display/test/certs/media-display.projecttechcycle-dev.org.key;
    root   /opt/homebrew/opt/nginx/html/media-display.projecttechcycle-dev.org;
    index  index.html index.htm;

    #charset koi8-r;
    proxy_set_header  X-Real-IP  $remote_addr;

    access_log  /opt/homebrew/var/log/nginx/media-display.projecttechcycle-dev.org.access.log;
    error_log  /opt/homebrew/var/log/nginx/media-display.projecttechcycle-dev.org.error.log;

    location /spotify/callback/ {
       proxy_pass      https://localhost:8888/callback/;
       proxy_ssl_verify off;
       proxy_set_header Host $host;
       proxy_set_header X-Real-IP $remote_addr;
    }

    # Enable directory listing for screensaver images folder
    location /assets/images/screensavers/ {
        autoindex on;
        autoindex_format html;
        autoindex_exact_size off;
        autoindex_localtime on;
        
        # CORS headers to allow JavaScript access
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Content-Type' always;
        
        # Cache images for faster loading
        expires 1d;
        add_header Cache-Control "public, immutable";
    }
    
    # General static assets caching
    location /assets/ {
        expires 1h;
        add_header Cache-Control "public";
    }

    location /notis/media-display/ {
      proxy_pass      http://localhost:5001/;
      # proxy_set_header Host localhost;
      # WebSocket support
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_set_header Host $host;
      
      # Additional recommended headers for proxying
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      
      # Timeouts for long-lived WebSocket connections
      proxy_read_timeout 86400;
    }
}